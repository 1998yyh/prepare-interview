# 缓存（服务器缓存）

缓存能加快页面的打开速度，也能减轻服务器压力，所以 HTTP 设计了缓存机制。

##　为什么要有缓存

网页中的代码和资源都是从服务器下载的，如果服务器和用户的浏览器离得比较远，那下载过程会比较耗时，网页打开也就比较慢。下次再访问这个网页的时候，又要重新再下载一次，如果资源没有啥变动的话，那这样的重新下载就很没必要。所以，HTTP 设计了缓存的功能，可以把下载的资源保存起来，再打开网页的时候直接读缓存，速度自然会快很多。


每个请求都要服务端做相应的处理，比如解析 url，读取文件，返回响应等，而服务器能同时处理的请求是有上限的，也就是负载是有上限的，所以如果能通过缓存减少没必要的资源的请求，就能解放服务器，让它去处理一些更有意义的请求。

## 那 HTTP 是怎么设计的缓存功能呢？

### http1.0
HTTP 1.0 的时候也是这么设计的，也就是 Expires 的 header，它可以指定资源过期时间，到这个时间之前不去请求服务器，直接拿上次下载好被缓存起来的内容，


``` http
Expires: Wed, 21 Oct 2021 07:28:00 GMT
```

这么操作会有一个问题，就是浏览器计算的时间和服务器计算的时间不一定一致。中间可能会有偏差。这样会导致过期时间和预想的不一致。

所以这个过期时间不应该让服务端来算，应该让浏览器自己计算。


### http1.1

为了解决上面问题,http1.1增加了 max-age的方式。

```
Cache-Control: max-age=600
```

上面就代表资源缓存 600 秒，也就是 10 分钟。

浏览器自己来计算啥时候过期。

 -age的格式与expires 的格式不一致，是因为http1.1把缓存相关的集中到了一起，放到了Cache-Control的header里面
了。 我们将其称之为指令。



### 协商缓存

如果只是过了过期时间，但是资源并不一定变了，有时候不一定要重新下载。所以就有了一个协商的过程。

当max-age的时间到了后，就可以带上etag和last-modified去请求服务器，问资源是否更新了，

带上etag的header叫做`If-None-Match`

```
If-None-Match: "bfc13a64729c4290ef5b2c2730249c88ca92d82d"
```

带上`last-modified`的时间叫做`If-Modified-Since`

```
If-Modified-Since: Wed, 21 Oct 2015 07:28:00 GMT
```

如果服务器判断资源有变化，那么就会返回200 并带上新的内容，浏览器就会去下载对应的资源。 如果是304 浏览器则会读取缓存。


如果确定文件不会变，不需要协商的话，可以设置immutable 的指令告诉浏览器。


### 代理服务器缓存

浏览器中缓存都是自己的，叫做私有缓存，而代理服务器的缓存大家都可以访问，叫做公有缓存。

如果这个资源只想让浏览器缓存，而不要代理服务器上缓存，那么设置private 否则设置public

```
Cache-control:public, max-age=600,s-maxage:31536000
```

比如上面这个就设置了，代理服务器缓存时间31536000

### 其他指令

#### 新鲜度

当缓存过期了，就完全不能使用了吗，其实还有这样的指令

``` 
Cache-control: max-stale=600
```

stale是不新鲜的意思，请求里带上max-stale设置600s,也就是过期后10分钟依然是可以用的，但是再长就不行了。

也可以设置 stale-while-revalidate，也就是说在和浏览器协商还没结束的时候，就先用着过期的缓存吧。

```
Cache-control: stale-while-revalidate=600
```

或者设置 stale-if-error，也就是说协商失败了的话，也先用着过期的缓存吧。

```
Cache-control: stale-if-error=600
```


那如果我想强制在缓存还没协商完的时候不用过期的缓存怎么办呢？

用这个指令 must-revalidate：

```
Cache-Control: max-age=31536000, must-revalidate
```

即 就是缓存失效了的话，必须等验证结束，中间不能用过期的缓存。

缓存不都是自己设置的么，咋还一个允许过期，一个禁止过期呢？

自己会同时用这两种和自己玩么？

自己肯定不会，但是 CDN 厂商可能会呀，想禁止这种用过期缓存的行为，就可以设置这个 must-revalidate 指令。

最后，HTTP 当然也支持禁止缓存，也就是这样：

``` 
Cache-control: no-store
```

设置了 no-store 的指令就不会缓存文件了，也就没有过期时间和之后的协商过程。

如果允许缓存，但是需要每次都协商下的话就用 no-cache:

```
Cache-control: no-cache
```

no-cache 相当于禁掉了强缓存，每次都要协商下，而 must-revalidate 只是在强缓存过期之后，禁止掉了用过期的缓存的过程，强制必须协商。

